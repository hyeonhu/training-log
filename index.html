<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Training Log</title>
  <style>
    :root{
      --bg:#0b0e14; --card:#121826; --muted:#9aa4b2; --text:#e6edf3;
      --line:#223049; --accent:#7aa2f7; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --chip:#1b2538;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#090b10,#0b0e14 40%,#090b10); color:var(--text);}
    header{position:sticky;top:0;z-index:5;background:rgba(11,14,20,.85);backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid rgba(255,255,255,.12); background:transparent; color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer}
    .tab.active{background:rgba(122,162,247,.15);border-color:rgba(122,162,247,.35)}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid.two{grid-template-columns:1.25fr .75fr}}
    .card{background:rgba(18,24,38,.85);border:1px solid rgba(255,255,255,.08);border-radius:18px;
      padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.35)}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:0 0 8px;font-size:14px;color:var(--muted);font-weight:600}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25); color:var(--text); outline:none}
    textarea{min-height:80px;resize:vertical}
    button{border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer}
    button.primary{background:rgba(122,162,247,.18);border-color:rgba(122,162,247,.35)}
    button.danger{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35)}
    button.ghost{background:transparent}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
    th{color:var(--muted);text-align:left;background:rgba(255,255,255,.03)}
    tr:hover td{background:rgba(255,255,255,.02)}
    .right{text-align:right}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:rgba(27,37,56,.9);border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:980px){.kpi{grid-template-columns:repeat(4,1fr)}}
    .kpi .box{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:16px;padding:12px}
    .kpi .big{font-size:20px;font-weight:700}
    .kpi .small{font-size:12px;color:var(--muted)}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    canvas{width:100%;height:320px;background:rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.08);
      border-radius:16px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .inline{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:980px){.inline{grid-template-columns:repeat(3,1fr)}}
    .toggle{display:flex;align-items:center;gap:8px}
    .toggle input{width:auto}
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <div class="row">
      <strong style="font-size:16px">Training Log</strong>
      <span class="pill" id="pillStatus">ë¡œì»¬ ì €ì¥</span>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="today">Today</button>
      <button class="tab" data-tab="setup">Setup</button>
      <button class="tab" data-tab="history">History</button>
      <button class="tab" data-tab="charts">Charts</button>
      <button class="tab" data-tab="backup">Backup</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- TODAY -->
  <section id="tab-today" class="grid two">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>ì˜¤ëŠ˜ ìš´ë™</h2>
        <div class="chips">
          <span class="chip" id="todayDateChip"></span>
          <span class="chip" id="todaySplitChip"></span>
        </div>
      </div>

      <div class="inline">
        <div>
          <label>ë‚ ì§œ</label>
          <input id="todayDate" type="date"/>
        </div>
        <div>
          <label>ë¶„í• (Workout Day)</label>
          <select id="todaySplit"></select>
        </div>
        <div>
          <label>ì˜µì…˜</label>
          <div class="toggle">
            <input id="toggleActual" type="checkbox"/>
            <span class="muted">ì‹¤ì œ ë¬´ê²Œ/ë°˜ë³µ ì…ë ¥(ì„ íƒ)</span>
          </div>
        </div>
      </div>

      <div class="btnrow" style="margin-top:10px">
        <button class="primary" id="btnBuildToday">ì˜¤ëŠ˜ ë£¨í‹´ ìƒì„±</button>
        <button id="btnMarkAllSuccess">ì „ì²´ ì„±ê³µ</button>
        <button id="btnMarkAllFail">ì „ì²´ ì‹¤íŒ¨</button>
        <button class="danger" id="btnClearToday">ì´ˆê¸°í™”</button>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto">
        <table id="todayTable">
          <thead>
            <tr>
              <th style="min-width:140px">ìš´ë™</th>
              <th style="min-width:80px">ë¶€ìœ„</th>
              <th class="right">ì„¸íŠ¸</th>
              <th class="right">ëª©í‘œ ë¬´ê²Œ</th>
              <th class="right">ëª©í‘œ ë°˜ë³µ</th>
              <th style="min-width:120px">ê²°ê³¼</th>
              <th class="right actualCol" style="display:none">ì‹¤ì œ ë¬´ê²Œ</th>
              <th class="right actualCol" style="display:none">ì‹¤ì œ ë°˜ë³µ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="btnrow" style="margin-top:10px">
        <button class="primary" id="btnSaveToday">ì˜¤ëŠ˜ ê¸°ë¡ ì €ì¥</button>
      </div>
      <div class="muted" style="margin-top:8px">
        * ê²°ê³¼ëŠ” ê° ìš´ë™ 1ê°œë§Œ ì„ íƒí•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤. (ì„¸íŠ¸ ìˆ˜ë§Œí¼ ìë™ ëˆ„ì )
      </div>
    </div>

    <div class="card">
      <h2>ìš”ì•½</h2>
      <div class="kpi">
        <div class="box">
          <div class="big" id="kpiExercises">0</div>
          <div class="small">ì˜¤ëŠ˜ ìš´ë™ ìˆ˜</div>
        </div>
        <div class="box">
          <div class="big" id="kpiSets">0</div>
          <div class="small">ì´ ì„¸íŠ¸</div>
        </div>
        <div class="box">
          <div class="big" id="kpiVolume">0</div>
          <div class="small">ì´ ë³¼ë¥¨(kgÂ·reps)</div>
        </div>
        <div class="box">
          <div class="big" id="kpiSuccess" >0</div>
          <div class="small">ì„±ê³µ ê°œìˆ˜</div>
        </div>
      </div>

      <div class="hr"></div>
      <h3>ì˜¤ëŠ˜ ëª©í‘œ(ìš”ì•½)</h3>
      <div class="muted" id="todaySummary"></div>
    </div>
  </section>

  <!-- SETUP -->
  <section id="tab-setup" class="grid two" style="display:none">
    <div class="card">
      <h2>ë¶„í•  / ë¶€ìœ„</h2>
      <div class="inline">
        <div>
          <label>ë¶„í•  ì¶”ê°€</label>
          <div class="row">
            <input id="newSplit" placeholder="ì˜ˆ: ë¬´ë¶„í• , ìƒì²´, í•˜ì²´, í‘¸ì‰¬, í’€"/>
            <button id="btnAddSplit">ì¶”ê°€</button>
          </div>
          <div class="hr"></div>
          <h3>ë¶„í•  ëª©ë¡</h3>
          <div id="splitList" class="chips"></div>
        </div>
        <div>
          <label>ë¶€ìœ„ ì¶”ê°€</label>
          <div class="row">
            <input id="newPart" placeholder="ì˜ˆ: ê°€ìŠ´, ë“±, ì–´ê¹¨, íŒ”, í•˜ì²´, ì½”ì–´"/>
            <button id="btnAddPart">ì¶”ê°€</button>
          </div>
          <div class="hr"></div>
          <h3>ë¶€ìœ„ ëª©ë¡</h3>
          <div id="partList" class="chips"></div>
        </div>
        <div>
          <h3>ê¸°ë³¸ê°’</h3>
          <div class="muted">ì²˜ìŒì—” ë¬´ë¶„í•  + ê¸°ë³¸ì„¸íŠ¸ 3ìœ¼ë¡œ ì‹œì‘í•´ë„ ì¶©ë¶„í•¨.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ìš´ë™ ì¶”ê°€/ìˆ˜ì •</h2>
      <div class="inline">
        <div>
          <label>ìš´ë™ëª…</label>
          <input id="exName" placeholder="ì˜ˆ: ë²¤ì¹˜í”„ë ˆìŠ¤"/>
        </div>
        <div>
          <label>ë¶€ìœ„</label>
          <select id="exPart"></select>
        </div>
        <div>
          <label>ì¶”ì²œ ë¶„í• </label>
          <select id="exSplit"></select>
        </div>
      </div>

      <div class="inline" style="margin-top:10px">
        <div>
          <label>ì‹œì‘ë¬´ê²Œ</label>
          <input id="exStartW" type="number" step="0.5" placeholder="ì˜ˆ: 50"/>
        </div>
        <div>
          <label>ìµœì†Œ ë°˜ë³µ</label>
          <input id="exMinR" type="number" step="1" placeholder="ì˜ˆ: 6"/>
        </div>
        <div>
          <label>ìµœëŒ€ ë°˜ë³µ</label>
          <input id="exMaxR" type="number" step="1" placeholder="ì˜ˆ: 10"/>
        </div>
      </div>

      <div class="inline" style="margin-top:10px">
        <div>
          <label>ì¦ëŸ‰í­(kg)</label>
          <input id="exInc" type="number" step="0.5" placeholder="ì˜ˆ: 2.5"/>
        </div>
        <div>
          <label>ê¸°ë³¸ ì„¸íŠ¸</label>
          <input id="exSets" type="number" step="1" placeholder="ì˜ˆ: 3"/>
        </div>
        <div>
          <label>ë©”ëª¨(ì„ íƒ)</label>
          <input id="exNote" placeholder="ì˜ˆ: ë¨¸ì‹ /ë°”ë²¨ ë“±"/>
        </div>
      </div>

      <div class="btnrow" style="margin-top:10px">
        <button class="primary" id="btnSaveExercise">ì €ì¥</button>
        <button id="btnResetExercise">ì…ë ¥ ì´ˆê¸°í™”</button>
      </div>

      <div class="hr"></div>
      <h3>ìš´ë™ ëª©ë¡</h3>
      <div style="overflow:auto">
        <table id="exerciseTable">
          <thead>
            <tr>
              <th>ìš´ë™</th><th>ë¶€ìœ„</th><th>ë¶„í• </th>
              <th class="right">ì‹œì‘</th><th class="right">min</th><th class="right">max</th>
              <th class="right">ì¦ëŸ‰</th><th class="right">ì„¸íŠ¸</th><th>ë©”ëª¨</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">* ìš´ë™ëª…ì€ ê³ ìœ  í‚¤ë¡œ ì‚¬ìš©ë¨(ì´ë¦„ ë°”ê¾¸ë©´ ìƒˆ ìš´ë™ìœ¼ë¡œ ì·¨ê¸‰).</div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="tab-history" class="grid two" style="display:none">
    <div class="card">
      <h2>ê¸°ë¡(History)</h2>
      <div class="inline">
        <div>
          <label>í•„í„°: ìš´ë™</label>
          <select id="histExercise"></select>
        </div>
        <div>
          <label>ê¸°ê°„(ì‹œì‘)</label>
          <input id="histFrom" type="date"/>
        </div>
        <div>
          <label>ê¸°ê°„(ë)</label>
          <input id="histTo" type="date"/>
        </div>
      </div>
      <div class="btnrow" style="margin-top:10px">
        <button class="primary" id="btnApplyHist">ì ìš©</button>
        <button class="danger" id="btnClearHist">í•„í„° ì´ˆê¸°í™”</button>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto">
        <table id="logTable">
          <thead>
            <tr>
              <th>ë‚ ì§œ</th><th>ë¶„í• </th><th>ë¶€ìœ„</th><th>ìš´ë™</th>
              <th class="right">ì„¸íŠ¸</th><th class="right">ë¬´ê²Œ</th><th class="right">ë°˜ë³µ</th>
              <th>ê²°ê³¼</th><th class="right">ë³¼ë¥¨</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="btnrow" style="margin-top:10px">
        <button class="danger" id="btnDeleteSelected">ì„ íƒ ì‚­ì œ</button>
      </div>
      <div class="muted">* í–‰ ì„ íƒì€ ì²´í¬ë°•ìŠ¤ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <div class="card">
      <h2>í˜„ì¬ ëª©í‘œ(Plan)</h2>
      <div class="muted">ê° ìš´ë™ì˜ â€œë‹¤ìŒ ëª©í‘œâ€ëŠ” ì„±ê³µ/ì‹¤íŒ¨ ê¸°ë¡ì— ë”°ë¼ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table id="planTable">
          <thead>
            <tr>
              <th>ìš´ë™</th><th>ë¶€ìœ„</th><th>ë¶„í• </th>
              <th class="right">ë‹¤ìŒ ë¬´ê²Œ</th><th class="right">ë‹¤ìŒ ë°˜ë³µ</th>
              <th class="right">ì„¸íŠ¸</th>
              <th class="right">min/max</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section id="tab-charts" class="grid two" style="display:none">
    <div class="card">
      <h2>ì°¨íŠ¸</h2>
      <div class="inline">
        <div>
          <label>ìš´ë™ ì„ íƒ</label>
          <select id="chartExercise"></select>
        </div>
        <div>
          <label>ì§€í‘œ</label>
          <select id="chartMetric">
            <option value="weight">ë¬´ê²Œ</option>
            <option value="reps">ë°˜ë³µ</option>
            <option value="volume">ë³¼ë¥¨(ë¬´ê²ŒÃ—ë°˜ë³µÃ—ì„¸íŠ¸)</option>
          </select>
        </div>
        <div>
          <label>í‘œì‹œ ê°œìˆ˜</label>
          <select id="chartN">
            <option value="30">ìµœê·¼ 30</option>
            <option value="60">ìµœê·¼ 60</option>
            <option value="120">ìµœê·¼ 120</option>
            <option value="9999">ì „ì²´</option>
          </select>
        </div>
      </div>
      <div class="hr"></div>
      <canvas id="chart"></canvas>
      <div class="muted" id="chartHint" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>ì „ì²´ ë³¼ë¥¨(ì¼ìë³„)</h2>
      <canvas id="chartTotal"></canvas>
      <div class="muted" style="margin-top:8px">* í•˜ë£¨ ì´ ë³¼ë¥¨ = ëª¨ë“  ìš´ë™(ë¬´ê²ŒÃ—ë°˜ë³µÃ—ì„¸íŠ¸)ì˜ í•©</div>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="tab-backup" class="grid two" style="display:none">
    <div class="card">
      <h2>ë°±ì—…</h2>
      <div class="btnrow">
        <button class="primary" id="btnExport">JSON ë‚´ë³´ë‚´ê¸°</button>
        <button id="btnCopyExport">í´ë¦½ë³´ë“œ ë³µì‚¬</button>
        <button class="danger" id="btnResetAll">ì „ì²´ ì´ˆê¸°í™”(ì£¼ì˜)</button>
      </div>
      <div class="hr"></div>
      <label>ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° JSON</label>
      <textarea id="backupText" placeholder="ì—¬ê¸°ì— JSONì´ í‘œì‹œë©ë‹ˆë‹¤. ê°€ì ¸ì˜¤ê¸°ëŠ” JSONì„ ë¶™ì—¬ë„£ê³  'ê°€ì ¸ì˜¤ê¸°'ë¥¼ ëˆ„ë¥´ì„¸ìš”."></textarea>
      <div class="btnrow" style="margin-top:10px">
        <button class="primary" id="btnImport">ê°€ì ¸ì˜¤ê¸°</button>
      </div>
      <div class="muted" style="margin-top:8px">
        * GitHub PagesëŠ” ì„œë²„ê°€ ì—†ì–´ì„œ ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €(ë¡œì»¬ìŠ¤í† ë¦¬ì§€)ì— ì €ì¥ë©ë‹ˆë‹¤.<br/>
        * íœ´ëŒ€í°/PC ë™ê¸°í™”í•˜ë ¤ë©´ ì¶”í›„ Supabase ê°™ì€ ë°±ì—”ë“œ ë¶™ì´ë©´ ë¨.
      </div>
    </div>

    <div class="card">
      <h2>ì´ˆê¸°ê°’</h2>
      <div class="muted">
        ì²« ì„¸íŒ…ì´ ê·€ì°®ìœ¼ë©´ ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ â€œê¸°ë³¸ ë¬´ë¶„í•  ì„¸íŠ¸â€ë¥¼ ìë™ ìƒì„±í•  ìˆ˜ ìˆì–´.
      </div>
      <div class="btnrow" style="margin-top:10px">
        <button class="primary" id="btnSeed">ê¸°ë³¸ ìš´ë™ ì„¸íŠ¸ ë„£ê¸°</button>
      </div>
    </div>
  </section>
</main>

<script>
/** ---------- Data Model ----------
state = {
  splits: string[],
  parts: string[],
  exercises: {
    [name]: { part, split, startW, minR, maxR, inc, sets, note }
  },
  plan: { [name]: { nextW, nextR } },  // computed/maintained
  log: Array<{id,date,split,part,exercise,sets,weight,reps,result,volume,actualW?,actualR?}>
}
*/
const KEY = "training_log_v1";
const uid = () => Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const todayISO = () => new Date().toISOString().slice(0,10);

function loadState(){
  const raw = localStorage.getItem(KEY);
  if(raw){
    try{ return JSON.parse(raw); }catch(e){}
  }
  // default minimal
  return {
    splits:["ë¬´ë¶„í• "],
    parts:["ê°€ìŠ´","ë“±","ì–´ê¹¨","íŒ”","í•˜ì²´","ì½”ì–´"],
    exercises:{},
    plan:{},
    log:[]
  };
}
function saveState(){
  localStorage.setItem(KEY, JSON.stringify(state));
  pill("ì €ì¥ë¨");
}
function pill(text){
  const el = document.getElementById("pillStatus");
  el.textContent = text;
  clearTimeout(pill._t);
  pill._t=setTimeout(()=>el.textContent="ë¡œì»¬ ì €ì¥",800);
}

let state = loadState();

/** ---------- Progression Rules ----------
- On success:
  - if nextR < maxR => nextR++
  - else (reach max) => nextW += inc; nextR = minR
- On fail: keep nextW/nextR
- Plan initializes from exercise.startW/minR
*/
function ensurePlan(name){
  if(!state.plan[name]){
    const ex = state.exercises[name];
    if(!ex) return;
    state.plan[name] = { nextW: num(ex.startW), nextR: int(ex.minR) };
  }
}
function applyResult(name, result){
  const ex = state.exercises[name]; if(!ex) return;
  ensurePlan(name);
  const p = state.plan[name];
  if(result !== "ì„±ê³µ") return; // ì‹¤íŒ¨ë©´ ìœ ì§€
  const maxR = int(ex.maxR), minR=int(ex.minR), inc=num(ex.inc);
  if(int(p.nextR) >= maxR){
    p.nextW = round1(num(p.nextW) + inc);
    p.nextR = minR;
  }else{
    p.nextR = int(p.nextR) + 1;
  }
}
function num(v){ const n = Number(v); return Number.isFinite(n)?n:0; }
function int(v){ const n = parseInt(v,10); return Number.isFinite(n)?n:0; }
function round1(v){ return Math.round(v*10)/10; }

/** ---------- UI Helpers ---------- */
function $(id){ return document.getElementById(id); }
function setOptions(sel, arr, withEmpty=false){
  sel.innerHTML = "";
  if(withEmpty){
    const o=document.createElement("option"); o.value=""; o.textContent="(ì „ì²´)";
    sel.appendChild(o);
  }
  arr.forEach(v=>{
    const o=document.createElement("option"); o.value=v; o.textContent=v;
    sel.appendChild(o);
  });
}
function el(tag, attrs={}, children=[]){
  const x=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==="class") x.className=v;
    else if(k==="html") x.innerHTML=v;
    else if(k.startsWith("on") && typeof v==="function") x.addEventListener(k.slice(2), v);
    else x.setAttribute(k,v);
  });
  children.forEach(c=>x.appendChild(c));
  return x;
}
function toast(msg){
  pill(msg);
}

/** ---------- Tabs ---------- */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const t=btn.dataset.tab;
    ["today","setup","history","charts","backup"].forEach(k=>{
      $("tab-"+k).style.display = (k===t) ? "" : "none";
    });
    renderAll();
  });
});

/** ---------- Setup: splits/parts ---------- */
$("btnAddSplit").addEventListener("click", ()=>{
  const v=$("newSplit").value.trim(); if(!v) return;
  if(!state.splits.includes(v)) state.splits.push(v);
  $("newSplit").value="";
  saveState(); renderAll();
});
$("btnAddPart").addEventListener("click", ()=>{
  const v=$("newPart").value.trim(); if(!v) return;
  if(!state.parts.includes(v)) state.parts.push(v);
  $("newPart").value="";
  saveState(); renderAll();
});

function renderChips(container, arr, onDelete){
  container.innerHTML="";
  arr.forEach(v=>{
    const c=el("span",{class:"chip"},[
      document.createTextNode(v+" "),
      el("button",{class:"ghost",style:"padding:0 6px;border:none;color:var(--muted);cursor:pointer", onclick:()=>onDelete(v)},[
        document.createTextNode("âœ•")
      ])
    ]);
    container.appendChild(c);
  });
}

/** ---------- Exercises CRUD ---------- */
function resetExerciseForm(){
  $("exName").value="";
  $("exStartW").value="";
  $("exMinR").value="";
  $("exMaxR").value="";
  $("exInc").value="";
  $("exSets").value="";
  $("exNote").value="";
}
$("btnResetExercise").addEventListener("click", resetExerciseForm);

$("btnSaveExercise").addEventListener("click", ()=>{
  const name=$("exName").value.trim();
  if(!name) return alert("ìš´ë™ëª…ì„ ì…ë ¥í•´");
  const ex = {
    part: $("exPart").value,
    split: $("exSplit").value,
    startW: num($("exStartW").value || 0),
    minR: int($("exMinR").value || 6),
    maxR: int($("exMaxR").value || 10),
    inc: num($("exInc").value || 2.5),
    sets: int($("exSets").value || 3),
    note: $("exNote").value.trim()
  };
  state.exercises[name]=ex;
  // ensure plan exists
  if(!state.plan[name]) state.plan[name]={ nextW: ex.startW, nextR: ex.minR };
  saveState(); renderAll(); toast("ìš´ë™ ì €ì¥");
});

function renderExerciseTable(){
  const tbody = $("exerciseTable").querySelector("tbody");
  tbody.innerHTML="";
  const names = Object.keys(state.exercises).sort((a,b)=>a.localeCompare(b,"ko"));
  names.forEach(name=>{
    const ex=state.exercises[name];
    const tr=document.createElement("tr");
    tr.appendChild(el("td",{html:name}));
    tr.appendChild(el("td",{html:ex.part||""}));
    tr.appendChild(el("td",{html:ex.split||""}));
    tr.appendChild(el("td",{class:"right",html:ex.startW}));
    tr.appendChild(el("td",{class:"right",html:ex.minR}));
    tr.appendChild(el("td",{class:"right",html:ex.maxR}));
    tr.appendChild(el("td",{class:"right",html:ex.inc}));
    tr.appendChild(el("td",{class:"right",html:ex.sets}));
    tr.appendChild(el("td",{html:ex.note||""}));
    const td=el("td",{class:"right"});
    const del=el("button",{class:"danger",onclick:()=>{
      if(!confirm(`ì‚­ì œ? ${name}`)) return;
      delete state.exercises[name];
      delete state.plan[name];
      // also remove logs of this exercise
      state.log = state.log.filter(x=>x.exercise!==name);
      saveState(); renderAll();
    }},[document.createTextNode("ì‚­ì œ")]);
    const edit=el("button",{style:"margin-right:6px",onclick:()=>{
      $("exName").value=name;
      $("exPart").value=ex.part||state.parts[0]||"";
      $("exSplit").value=ex.split||state.splits[0]||"";
      $("exStartW").value=ex.startW;
      $("exMinR").value=ex.minR;
      $("exMaxR").value=ex.maxR;
      $("exInc").value=ex.inc;
      $("exSets").value=ex.sets;
      $("exNote").value=ex.note||"";
      toast("ìˆ˜ì • í›„ ì €ì¥");
    }},[document.createTextNode("ìˆ˜ì •")]);
    td.appendChild(edit); td.appendChild(del);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}

/** ---------- Today ---------- */
$("todayDate").value = todayISO();
$("todayDate").addEventListener("change", ()=> renderTodayChips());
$("todaySplit").addEventListener("change", ()=> renderTodayChips());

$("toggleActual").addEventListener("change", ()=>{
  const show = $("toggleActual").checked;
  document.querySelectorAll(".actualCol").forEach(x=>x.style.display = show ? "" : "none");
  renderTodayTable();
});

let todayRows = []; // {name, part, sets, targetW, targetR, result, actualW?, actualR?}

function buildToday(){
  const split = $("todaySplit").value;
  const names = Object.keys(state.exercises);
  if(names.length===0){
    alert("Setupì—ì„œ ìš´ë™ì„ ë¨¼ì € ì¶”ê°€í•´.");
    return;
  }
  todayRows = names
    .map(n=>({name:n, ...state.exercises[n]}))
    .filter(x=> !split || (x.split===split))
    .sort((a,b)=>a.part.localeCompare(b.part,"ko") || a.name.localeCompare(b.name,"ko"))
    .map(x=>{
      ensurePlan(x.name);
      const p = state.plan[x.name];
      return {
        name:x.name,
        part:x.part,
        sets:int(x.sets||3),
        targetW: num(p.nextW),
        targetR: int(p.nextR),
        result:"",
        actualW:"",
        actualR:""
      };
    });

  renderTodayTable();
  renderTodayKPIs();
  renderTodaySummary();
  toast("ì˜¤ëŠ˜ ë£¨í‹´ ìƒì„±");
}

$("btnBuildToday").addEventListener("click", buildToday);

$("btnClearToday").addEventListener("click", ()=>{
  todayRows = [];
  renderTodayTable(); renderTodayKPIs(); renderTodaySummary();
});

$("btnMarkAllSuccess").addEventListener("click", ()=>{
  todayRows.forEach(r=>r.result="ì„±ê³µ");
  renderTodayTable(); renderTodayKPIs();
});
$("btnMarkAllFail").addEventListener("click", ()=>{
  todayRows.forEach(r=>r.result="ì‹¤íŒ¨");
  renderTodayTable(); renderTodayKPIs();
});

function renderTodayChips(){
  $("todayDateChip").textContent = "ğŸ“… " + ($("todayDate").value || todayISO());
  $("todaySplitChip").textContent = "ğŸ§© " + ($("todaySplit").value || "-");
}

function renderTodayTable(){
  const tbody = $("todayTable").querySelector("tbody");
  tbody.innerHTML="";
  const showActual = $("toggleActual").checked;

  todayRows.forEach((r, idx)=>{
    const tr=document.createElement("tr");
    tr.appendChild(el("td",{html:r.name}));
    tr.appendChild(el("td",{html:r.part}));
    tr.appendChild(el("td",{class:"right",html:r.sets}));

    tr.appendChild(el("td",{class:"right",html:r.targetW}));
    tr.appendChild(el("td",{class:"right",html:r.targetR}));

    const sel=el("select",{});
    ["","ì„±ê³µ","ì‹¤íŒ¨"].forEach(v=>{
      const o=document.createElement("option"); o.value=v; o.textContent = v||"(ì„ íƒ)";
      sel.appendChild(o);
    });
    sel.value=r.result||"";
    sel.addEventListener("change", ()=>{ r.result=sel.value; renderTodayKPIs(); });
    tr.appendChild(el("td",{},[sel]));

    if(showActual){
      const iw=el("input",{type:"number",step:"0.5",value:r.actualW||"",style:"text-align:right"});
      iw.addEventListener("input", ()=>{ r.actualW=iw.value; });
      const ir=el("input",{type:"number",step:"1",value:r.actualR||"",style:"text-align:right"});
      ir.addEventListener("input", ()=>{ r.actualR=ir.value; });
      tr.appendChild(el("td",{class:"right"},[iw]));
      tr.appendChild(el("td",{class:"right"},[ir]));
    }else{
      tr.appendChild(el("td",{class:"right actualCol",style:"display:none"}));
      tr.appendChild(el("td",{class:"right actualCol",style:"display:none"}));
    }

    tbody.appendChild(tr);
  });
}

function renderTodayKPIs(){
  const exN = todayRows.length;
  const sets = todayRows.reduce((a,b)=>a+int(b.sets),0);
  const volume = todayRows.reduce((a,b)=>a + int(b.sets)*num(b.targetW)*int(b.targetR),0);
  const succ = todayRows.filter(x=>x.result==="ì„±ê³µ").length;
  $("kpiExercises").textContent = exN;
  $("kpiSets").textContent = sets;
  $("kpiVolume").textContent = Math.round(volume);
  $("kpiSuccess").textContent = succ;
  $("kpiSuccess").className = "big " + (succ===exN && exN>0 ? "good" : "");
}
function renderTodaySummary(){
  if(todayRows.length===0){ $("todaySummary").textContent="ì˜¤ëŠ˜ ë£¨í‹´ì„ ìƒì„±í•˜ì„¸ìš”."; return; }
  const byPart = {};
  todayRows.forEach(r=>{
    byPart[r.part] = byPart[r.part] || [];
    byPart[r.part].push(r);
  });
  const parts = Object.keys(byPart);
  let out="";
  parts.forEach(p=>{
    const list=byPart[p];
    out += `â€¢ ${p}: ${list.length}ì¢…ëª©\n`;
  });
  $("todaySummary").textContent = out.trim();
}

/** Save Today -> Log (and update Plan) */
$("btnSaveToday").addEventListener("click", ()=>{
  if(todayRows.length===0) return alert("ì˜¤ëŠ˜ ë£¨í‹´ì„ ë¨¼ì € ìƒì„±í•´.");
  const date = $("todayDate").value || todayISO();
  const split = $("todaySplit").value || "ë¬´ë¶„í• ";
  const showActual = $("toggleActual").checked;

  // Save only rows with result selected
  const selected = todayRows.filter(r=>r.result==="ì„±ê³µ" || r.result==="ì‹¤íŒ¨");
  if(selected.length===0) return alert("ê²°ê³¼ë¥¼ ì„ íƒí•œ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.");

  selected.forEach(r=>{
    // determine performed values: either actual(when provided) else target
    const w = (showActual && r.actualW!=="") ? num(r.actualW) : num(r.targetW);
    const reps = (showActual && r.actualR!=="") ? int(r.actualR) : int(r.targetR);

    const sets = int(r.sets);
    const vol = sets * w * reps;

    state.log.push({
      id: uid(),
      date, split,
      part: r.part,
      exercise: r.name,
      sets,
      weight: w,
      reps,
      result: r.result,
      volume: vol
    });

    // update progression based on result
    applyResult(r.name, r.result);
  });

  saveState();
  toast("ì €ì¥ ì™„ë£Œ");
  renderAll();
});

/** ---------- History ---------- */
function renderLogTable(){
  const tbody = $("logTable").querySelector("tbody");
  tbody.innerHTML="";

  const ex = $("histExercise").value;
  const from = $("histFrom").value;
  const to = $("histTo").value;

  let rows = [...state.log];
  if(ex) rows = rows.filter(r=>r.exercise===ex);
  if(from) rows = rows.filter(r=>r.date>=from);
  if(to) rows = rows.filter(r=>r.date<=to);
  rows.sort((a,b)=> b.date.localeCompare(a.date));

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const cb=el("input",{type:"checkbox","data-id":r.id});
    tr.appendChild(el("td",{},[cb, document.createTextNode(" "+r.date)]));
    tr.appendChild(el("td",{html:r.split}));
    tr.appendChild(el("td",{html:r.part}));
    tr.appendChild(el("td",{html:r.exercise}));
    tr.appendChild(el("td",{class:"right",html:r.sets}));
    tr.appendChild(el("td",{class:"right",html:r.weight}));
    tr.appendChild(el("td",{class:"right",html:r.reps}));
    tr.appendChild(el("td",{html: r.result==="ì„±ê³µ" ? `<span class="good">ì„±ê³µ</span>` : `<span class="bad">ì‹¤íŒ¨</span>`}));
    tr.appendChild(el("td",{class:"right",html:Math.round(r.volume)}));
    tbody.appendChild(tr);
  });
}

$("btnApplyHist").addEventListener("click", renderLogTable);
$("btnClearHist").addEventListener("click", ()=>{
  $("histExercise").value="";
  $("histFrom").value="";
  $("histTo").value="";
  renderLogTable();
});

$("btnDeleteSelected").addEventListener("click", ()=>{
  const ids = [...$("logTable").querySelectorAll('input[type="checkbox"][data-id]:checked')]
    .map(x=>x.dataset.id);
  if(ids.length===0) return alert("ì‚­ì œí•  í–‰ì„ ì„ íƒí•´.");
  if(!confirm(`${ids.length}ê°œ ê¸°ë¡ ì‚­ì œ?`)) return;
  state.log = state.log.filter(r=>!ids.includes(r.id));
  saveState(); renderAll();
});

/** ---------- Plan Table ---------- */
function renderPlanTable(){
  const tbody = $("planTable").querySelector("tbody");
  tbody.innerHTML="";
  const names = Object.keys(state.exercises).sort((a,b)=>a.localeCompare(b,"ko"));
  names.forEach(name=>{
    const ex=state.exercises[name];
    ensurePlan(name);
    const p=state.plan[name];
    const tr=document.createElement("tr");
    tr.appendChild(el("td",{html:name}));
    tr.appendChild(el("td",{html:ex.part}));
    tr.appendChild(el("td",{html:ex.split}));
    tr.appendChild(el("td",{class:"right",html:p.nextW}));
    tr.appendChild(el("td",{class:"right",html:p.nextR}));
    tr.appendChild(el("td",{class:"right",html:ex.sets}));
    tr.appendChild(el("td",{class:"right",html:`${ex.minR}/${ex.maxR}`}));
    tbody.appendChild(tr);
  });
}

/** ---------- Charts (vanilla canvas) ---------- */
function drawLineChart(canvas, labels, values, title){
  const ctx = canvas.getContext("2d");
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,W,H);

  const pad = 48*devicePixelRatio;
  const innerW = W - pad*2;
  const innerH = H - pad*2;

  // title
  ctx.fillStyle = "rgba(230,237,243,.9)";
  ctx.font = `${14*devicePixelRatio}px system-ui`;
  ctx.fillText(title, pad, pad*0.65);

  if(values.length===0){
    ctx.fillStyle="rgba(154,164,178,.8)";
    ctx.font = `${12*devicePixelRatio}px system-ui`;
    ctx.fillText("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", pad, pad+20*devicePixelRatio);
    return;
  }

  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = (max-min) || 1;

  // axes
  ctx.strokeStyle="rgba(255,255,255,.10)";
  ctx.lineWidth=1*devicePixelRatio;
  ctx.beginPath();
  ctx.moveTo(pad, H-pad);
  ctx.lineTo(W-pad, H-pad);
  ctx.lineTo(W-pad, pad);
  ctx.stroke();

  // grid + y labels
  ctx.fillStyle="rgba(154,164,178,.8)";
  ctx.font = `${11*devicePixelRatio}px system-ui`;
  for(let i=0;i<=4;i++){
    const y = pad + (innerH*(i/4));
    ctx.strokeStyle="rgba(255,255,255,.06)";
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
    const val = (max - range*(i/4));
    ctx.fillText(val.toFixed(0), 10*devicePixelRatio, y+4*devicePixelRatio);
  }

  // line
  ctx.strokeStyle="rgba(122,162,247,.9)";
  ctx.lineWidth=2*devicePixelRatio;
  ctx.beginPath();
  values.forEach((v,i)=>{
    const x = pad + innerW*(i/(values.length-1 || 1));
    const y = pad + innerH*(1-((v-min)/range));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // dots
  ctx.fillStyle="rgba(122,162,247,.9)";
  values.forEach((v,i)=>{
    const x = pad + innerW*(i/(values.length-1 || 1));
    const y = pad + innerH*(1-((v-min)/range));
    ctx.beginPath(); ctx.arc(x,y,3*devicePixelRatio,0,Math.PI*2); ctx.fill();
  });

  // x labels (sparse)
  ctx.fillStyle="rgba(154,164,178,.75)";
  const step = Math.ceil(values.length/6);
  for(let i=0;i<labels.length;i+=step){
    const x = pad + innerW*(i/(labels.length-1 || 1));
    ctx.save();
    ctx.translate(x, H-pad+14*devicePixelRatio);
    ctx.rotate(-0.4);
    ctx.fillText(labels[i].slice(5), 0, 0);
    ctx.restore();
  }
}

function renderCharts(){
  const ex = $("chartExercise").value;
  const metric = $("chartMetric").value;
  const N = int($("chartN").value);

  let rows = [...state.log];
  if(ex) rows = rows.filter(r=>r.exercise===ex);
  rows.sort((a,b)=> a.date.localeCompare(b.date));

  // aggregate by date for selected exercise
  const byDate = new Map();
  rows.forEach(r=>{
    const k=r.date;
    const cur = byDate.get(k) || {vol:0,w:0,reps:0,count:0};
    cur.vol += r.volume;
    cur.w += r.weight;
    cur.reps += r.reps;
    cur.count += 1;
    byDate.set(k,cur);
  });

  let labels = [...byDate.keys()].sort();
  if(N !== 9999) labels = labels.slice(Math.max(0, labels.length-N));
  const vals = labels.map(d=>{
    const x=byDate.get(d);
    if(metric==="volume") return x.vol;
    if(metric==="weight") return x.w / (x.count||1);
    return x.reps / (x.count||1);
  });

  const title = ex ? `${ex} - ${metric==="weight"?"ë¬´ê²Œ":metric==="reps"?"ë°˜ë³µ":"ë³¼ë¥¨"}` : "ìš´ë™ì„ ì„ íƒí•˜ì„¸ìš”";
  drawLineChart($("chart"), labels, vals, title);
  $("chartHint").textContent = ex ? "ë¬´ê²Œ/ë°˜ë³µì€ ê¸°ë¡ëœ ê°’ì˜ í‰ê· (ì¼ì ê¸°ì¤€), ë³¼ë¥¨ì€ í•©ê³„" : "";

  // total volume per day
  const totalMap = new Map();
  state.log.forEach(r=>{
    totalMap.set(r.date, (totalMap.get(r.date)||0) + r.volume);
  });
  const tlabels = [...totalMap.keys()].sort();
  const tvals = tlabels.map(d=>totalMap.get(d));
  drawLineChart($("chartTotal"), tlabels.slice(Math.max(0,tlabels.length-90)), tvals.slice(Math.max(0,tvals.length-90)), "ìµœê·¼ 90ì¼ ì´ë³¼ë¥¨");
}

/** ---------- Backup ---------- */
$("btnExport").addEventListener("click", ()=>{
  $("backupText").value = JSON.stringify(state, null, 2);
});
$("btnCopyExport").addEventListener("click", async ()=>{
  const txt = $("backupText").value || JSON.stringify(state);
  await navigator.clipboard.writeText(txt);
  toast("ë³µì‚¬ë¨");
});
$("btnImport").addEventListener("click", ()=>{
  try{
    const obj = JSON.parse($("backupText").value);
    state = obj;
    saveState(); renderAll(); toast("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");
  }catch(e){
    alert("JSON íŒŒì‹± ì‹¤íŒ¨");
  }
});
$("btnResetAll").addEventListener("click", ()=>{
  if(!confirm("ì „ì²´ ì´ˆê¸°í™”? ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.")) return;
  localStorage.removeItem(KEY);
  state = loadState();
  saveState(); renderAll();
});
$("btnSeed").addEventListener("click", ()=>{
  // seed: minimal full-body list
  if(Object.keys(state.exercises).length>0 && !confirm("ì´ë¯¸ ìš´ë™ì´ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì§€ ì•Šê³  ì¶”ê°€í• ê¹Œìš”?")) return;
  if(!state.splits.includes("ë¬´ë¶„í• ")) state.splits.push("ë¬´ë¶„í• ");
  const add = (name,part,startW,minR,maxR,inc,sets,split="ë¬´ë¶„í• ")=>{
    state.exercises[name]={part,split,startW,minR,maxR,inc,sets,note:""};
    state.plan[name]={nextW:startW,nextR:minR};
  };
  add("ë²¤ì¹˜í”„ë ˆìŠ¤","ê°€ìŠ´",50,6,10,2.5,3);
  add("ë«í’€ë‹¤ìš´","ë“±",45,8,12,5,3);
  add("ì˜¤ë²„í—¤ë“œí”„ë ˆìŠ¤","ì–´ê¹¨",30,5,8,2.5,3);
  add("ì‚¬ë ˆë ˆ","ì–´ê¹¨",8,12,20,1,2);
  add("ë°”ë²¨ì»¬","íŒ”",20,8,12,2.5,2);
  add("í‘¸ì‹œë‹¤ìš´","íŒ”",25,8,12,2.5,2);
  add("ë ˆê·¸í”„ë ˆìŠ¤","í•˜ì²´",100,6,10,5,3);
  add("RDL","í•˜ì²´",60,6,10,5,2);
  add("ë ˆê·¸ë ˆì´ì¦ˆ","ì½”ì–´",0,10,15,0,2);
  saveState(); renderAll(); toast("ê¸°ë³¸ ì„¸íŠ¸ ì¶”ê°€");
});

/** ---------- Init Selects ---------- */
function refreshSelects(){
  setOptions($("todaySplit"), state.splits);
  setOptions($("exPart"), state.parts);
  setOptions($("exSplit"), state.splits);
  const exNames = Object.keys(state.exercises).sort((a,b)=>a.localeCompare(b,"ko"));
  setOptions($("histExercise"), exNames, true);
  setOptions($("chartExercise"), exNames, true);
}

/** ---------- Render All ---------- */
function renderAll(){
  refreshSelects();
  renderTodayChips();
  renderTodayTable();
  renderTodayKPIs();
  renderTodaySummary();
  renderExerciseTable();
  renderChips($("splitList"), state.splits, (v)=>{
    if(v==="ë¬´ë¶„í• " && state.splits.length===1) return alert("ë§ˆì§€ë§‰ ë¶„í• ì€ ì‚­ì œ ë¶ˆê°€");
    if(!confirm(`ë¶„í•  ì‚­ì œ? ${v}`)) return;
    state.splits = state.splits.filter(x=>x!==v);
    // also adjust exercises with that split
    Object.values(state.exercises).forEach(ex=>{ if(ex.split===v) ex.split=state.splits[0]||"ë¬´ë¶„í• "; });
    saveState(); renderAll();
  });
  renderChips($("partList"), state.parts, (v)=>{
    if(!confirm(`ë¶€ìœ„ ì‚­ì œ? ${v}`)) return;
    state.parts = state.parts.filter(x=>x!==v);
    Object.values(state.exercises).forEach(ex=>{ if(ex.part===v) ex.part=state.parts[0]||"ê¸°íƒ€"; });
    saveState(); renderAll();
  });
  renderLogTable();
  renderPlanTable();
  renderCharts();
}

renderAll();

// default split chip
$("todaySplit").value = state.splits[0] || "ë¬´ë¶„í• ";
renderTodayChips();
</script>
</body>
</html>
